{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="step-indicator">
                <div class="step active">
                    <div class="number">1</div>
                    <div>需求分析</div>
                </div>
                <div class="step">
                    <div class="number">2</div>
                    <div>AHP评估</div>
                </div>
                <div class="step">
                    <div class="number">3</div>
                    <div>提示词生成</div>
                </div>
                <div class="step">
                    <div class="number">4</div>
                    <div>概念筛选</div>
                </div>
                <div class="step">
                    <div class="number">5</div>
                    <div>方案评估</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">需求分析模块</h4>
                </div>
                <div class="card-body">
                    <h5>Step 1: 选择数据输入方式</h5>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6>方式1：手动上传文件</h6>
                                </div>
                                <div class="card-body">
                                    <form id="uploadForm" method="POST" enctype="multipart/form-data">
                                        <input type="hidden" name="data_type" value="upload">
                                        <div class="mb-3">
                                            <label class="form-label">选择文件（支持：PDF、DOC、TXT、CSV）</label>
                                            <input type="file" class="form-control" name="files" multiple accept=".pdf,.doc,.docx,.txt,.csv">
                                            <div class="form-text">可上传学术文献、专利文档、用户评论、产品数据等</div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">上传并分析</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6>方式2：AI自动检索</h6>
                                </div>
                                <div class="card-body">
                                    <form id="searchForm" method="POST">
                                        <input type="hidden" name="data_type" value="search">
                                        <div class="mb-3">
                                            <label class="form-label">输入双领域组合关键词</label>
                                            <input type="text" class="form-control" name="keywords" placeholder="社区医疗车辆+可达性" required>
                                            <div class="form-text">格式：领域1+领域2，使用+号连接</div>
                                        </div>
                                        <button type="submit" class="btn btn-success">AI检索分析</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 结果显示区域 -->
                    <div id="resultSection" style="display: none;">
                        <h5>Step 2: 数据校验</h5>
                        <div class="card mb-3">
                            <div class="card-header">
                                AI提取的文献元数据
                            </div>
                            <div class="card-body">
                                <table class="table data-table" id="metadataTable">
                                    <thead>
                                        <tr>
                                            <th>标题</th>
                                            <th>作者</th>
                                            <th>机构</th>
                                            <th>参考文献数</th>
                                            <th>校验</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 数据会通过JS动态填充 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <h5>Step 3: 需求提取结果</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header bg-warning">
                                        用户痛点
                                    </div>
                                    <div class="card-body" id="painPoints">
                                        <!-- 数据会通过JS动态填充 -->
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header bg-info">
                                        隐含情感需求
                                    </div>
                                    <div class="card-body" id="emotionalNeeds">
                                        <!-- 数据会通过JS动态填充 -->
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-header bg-success">
                                        功能关键词
                                    </div>
                                    <div class="card-body" id="keywords">
                                        <!-- 数据会通过JS动态填充 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button class="btn btn-lg btn-primary" onclick="proceedToAHP()">进入AHP评估</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 表单提交处理
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitForm(this);
    });
    
    document.getElementById('searchForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitForm(this);
    });
});

async function submitForm(form) {
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 处理中...';
    
    try {
        const response = await fetch('/demand-analysis', {
            method: 'POST',
            body: new FormData(form)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showResults(result.data);
            Utils.showAlert('分析成功！', 'success');
        } else {
            Utils.showAlert('分析失败，请重试', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        Utils.showAlert('网络错误，请重试', 'danger');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

function showResults(data) {
    // 显示结果区域
    document.getElementById('resultSection').style.display = 'block';
    
    // 填充元数据表格
    const metadataTable = document.querySelector('#metadataTable tbody');
    metadataTable.innerHTML = '';
    data.metadata.forEach(item => {
        const row = `<tr>
            <td>${item.title}</td>
            <td>${item.authors}</td>
            <td>${item.institution}</td>
            <td>${item.references}</td>
            <td><input type="checkbox" checked class="form-check-input"></td>
        </tr>`;
        metadataTable.innerHTML += row;
    });
    
    // 填充用户痛点
    const painPoints = document.getElementById('painPoints');
    painPoints.innerHTML = '';
    data.pain_points.forEach(point => {
        painPoints.innerHTML += `<div class="form-check">
            <input class="form-check-input" type="checkbox" checked id="point-${point}">
            <label class="form-check-label" for="point-${point}">${point}</label>
        </div>`;
    });
    
    // 填充情感需求
    const emotionalNeeds = document.getElementById('emotionalNeeds');
    emotionalNeeds.innerHTML = '';
    data.emotional_needs.forEach(need => {
        emotionalNeeds.innerHTML += `<div class="form-check">
            <input class="form-check-input" type="checkbox" checked id="need-${need}">
            <label class="form-check-label" for="need-${need}">${need}</label>
        </div>`;
    });
    
    // 填充关键词
    const keywords = document.getElementById('keywords');
    keywords.innerHTML = '';
    data.keywords.forEach(keyword => {
        keywords.innerHTML += `<span class="badge bg-secondary me-1 mb-1">${keyword}</span>`;
    });
    
    // 滚动到结果区域
    document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
}

function proceedToAHP() {
    window.location.href = '/ahp-evaluation';
}
</script>
{% endblock %}